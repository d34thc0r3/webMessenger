<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>WebMessenger</title>

    <style>
      :root {
        --bg: #ffffff;
        --fg: #111111;
        --muted: #666666;
        --border: #d0d0d0;
        --panel: #f6f6f6;
        --btnbg: #ffffff;
        --btnfg: #111111;
        --accent: #2563eb;
      }
      body.dark {
        --bg: #0b0f14;
        --fg: #dbe7ff;
        --muted: #7f8da3;
        --border: #253246;
        --panel: #0f1722;
        --btnbg: #121b28;
        --btnfg: #dbe7ff;
        --accent: #60a5fa;
      }

      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        background: var(--bg);
        color: var(--fg);
      }

      .wrap {
        max-width: 900px;
        margin: 0 auto;
        padding: 16px;
      }

      h2, h3 { margin: 0 0 12px 0; }
      .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
      .row > * { flex: 0 0 auto; }
      .spacer { flex: 1 1 auto; }

      input {
        background: var(--btnbg);
        color: var(--btnfg);
        border: 1px solid var(--border);
        padding: 10px 12px;
        border-radius: 10px;
        outline: none;
      }

      button {
        background: var(--btnbg);
        color: var(--btnfg);
        border: 1px solid var(--border);
        padding: 10px 12px;
        border-radius: 10px;
        cursor: pointer;
      }
      button:hover { border-color: var(--accent); }

      .panel {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 12px;
      }

      #log {
        width: 100%;
        height: 360px;
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 12px;
        overflow-y: auto;
        white-space: pre-wrap;
        background: transparent;
        margin: 10px 0;
        font-size: 14px;
        line-height: 1.45;
      }

      .hint {
        color: var(--muted);
        font-size: 12px;
        margin-top: 8px;
      }

      .pill {
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: transparent;
        color: var(--muted);
        font-size: 12px;
      }

      a { color: var(--accent); }
    </style>
  </head>

  <body>
    <div class="wrap">

      <!-- JOIN VIEW -->
      <div id="join-view" class="panel">
        <div class="row">
          <h3 style="margin:0;">WebMessenger</h3>
          <span class="spacer"></span>
          <button id="theme-btn" title="ë‹¤í¬ëª¨ë“œ í† ê¸€">ğŸŒ™/â˜€ï¸</button>
        </div>

        <div class="row" style="margin-top:12px;">
          <label class="pill">ë°© ë²ˆí˜¸</label>
          <input id="room" placeholder="ì˜ˆ: 1234" />
          <button id="new-room">ìƒˆ ë°©</button>
        </div>

        <div class="row" style="margin-top:8px;">
          <label class="pill">ë‹‰ë„¤ì„</label>
          <input id="name" placeholder="ì˜ˆ: csskim" />
          <span class="spacer"></span>
          <label class="pill" style="display:flex; gap:6px; align-items:center;">
            <input id="sound-toggle" type="checkbox" style="margin:0;" />
            ì•Œë¦¼ìŒ
          </label>
        </div>

        <div class="row" style="margin-top:12px;">
          <button id="join-btn">ì…ì¥í•˜ê¸°</button>
          <span class="hint">íŒ: ê°™ì€ ë°© ë²ˆí˜¸ë¥¼ ì…ë ¥í•œ ì‚¬ëŒë¼ë¦¬ ì±„íŒ…í•©ë‹ˆë‹¤.</span>
        </div>

        <div class="hint">
          ë§í¬ë¡œ ë°”ë¡œ ì…ì¥ë„ ë©ë‹ˆë‹¤: <span class="pill">?room=1234&name=ë‹‰</span>
        </div>
      </div>

      <!-- CHAT VIEW -->
      <div id="chat-view" class="panel" style="display:none;">
        <div class="row">
          <div class="pill">
            <span id="room-label"></span> ë°©
          </div>
          <span class="pill" id="name-label"></span>

          <span class="spacer"></span>

          <!-- (1) ë§í¬ ê³µìœ  -->
          <button id="share-btn" title="í˜„ì¬ ë°© ë§í¬ ë³µì‚¬">ë§í¬ ë³µì‚¬</button>

          <!-- (5) ë¡œê·¸ ë³µì‚¬ -->
          <button id="copy-btn" title="ì±„íŒ… ë¡œê·¸ ì „ì²´ ë³µì‚¬">ë¡œê·¸ ë³µì‚¬</button>

          <!-- ë‹¤í¬ëª¨ë“œ í† ê¸€ -->
          <button id="theme-btn2" title="ë‹¤í¬ëª¨ë“œ í† ê¸€">ğŸŒ™/â˜€ï¸</button>
        </div>

        <!-- (ë‹¤í¬ëª¨ë“œ í¬í•¨) IRC ìŠ¤íƒ€ì¼ ë¡œê·¸ -->
        <pre id="log"></pre>

        <div class="row">
          <input id="msg" style="flex: 1 1 auto; min-width: 220px;" autocomplete="off" placeholder="ë©”ì‹œì§€ ì…ë ¥ (Enter ì „ì†¡)" />
          <button id="send-btn">ì „ì†¡</button>
        </div>

        <div class="hint">
          (4) ëª…ë ¹ì–´: <span class="pill">/help</span> <span class="pill">/clear</span> <span class="pill">/nick ìƒˆë‹‰</span> <span class="pill">/me í–‰ë™</span>
        </div>
      </div>

    </div>

    <!-- socket.io client -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
      // -----------------------------
      // ê¸°ë³¸ ìš”ì†Œ
      // -----------------------------
      const socket = io();

      const joinView = document.getElementById("join-view");
      const chatView = document.getElementById("chat-view");

      const roomInput = document.getElementById("room");
      const nameInput = document.getElementById("name");
      const joinBtn = document.getElementById("join-btn");
      const newRoomBtn = document.getElementById("new-room");

      const roomLabel = document.getElementById("room-label");
      const nameLabel = document.getElementById("name-label");

      const log = document.getElementById("log");
      const msgInput = document.getElementById("msg");
      const sendBtn = document.getElementById("send-btn");

      const shareBtn = document.getElementById("share-btn"); // (1)
      const copyBtn = document.getElementById("copy-btn");   // (5)

      const themeBtn1 = document.getElementById("theme-btn");
      const themeBtn2 = document.getElementById("theme-btn2");

      const soundToggle = document.getElementById("sound-toggle"); // (3)

      // -----------------------------
      // (2) ë‹‰ë„¤ì„ ê¸°ì–µí•˜ê¸° + (3) ì•Œë¦¼ í† ê¸€ ê¸°ì–µ
      // -----------------------------
      const savedName = localStorage.getItem("wm_name");
      if (savedName) nameInput.value = savedName;

      const savedSound = localStorage.getItem("wm_sound");
      soundToggle.checked = savedSound === "1";

      soundToggle.addEventListener("change", () => {
        localStorage.setItem("wm_sound", soundToggle.checked ? "1" : "0");
      });

      // -----------------------------
      // ë‹¤í¬ëª¨ë“œ (localStorage ê¸°ì–µ)
      // -----------------------------
      function applyTheme(theme) {
        document.body.classList.toggle("dark", theme === "dark");
        localStorage.setItem("wm_theme", theme);
      }
      const savedTheme = localStorage.getItem("wm_theme") || "dark";
      applyTheme(savedTheme);

      function toggleTheme() {
        const nowDark = document.body.classList.contains("dark");
        applyTheme(nowDark ? "light" : "dark");
      }
      themeBtn1.onclick = toggleTheme;
      themeBtn2.onclick = toggleTheme;

      // -----------------------------
      // ë¡œê·¸ ì¶œë ¥
      // -----------------------------
      function appendLine(text) {
        log.textContent += text + "\n";
        log.scrollTop = log.scrollHeight;
      }

      // -----------------------------
      // (3) ìƒˆ ë©”ì‹œì§€ ì•Œë¦¼: ì œëª© ë±ƒì§€ + (ì„ íƒ) ì‚ ì†Œë¦¬
      // -----------------------------
      let unread = 0;
      let hasFocus = true;

      window.addEventListener("focus", () => {
        hasFocus = true;
        unread = 0;
        document.title = "WebMessenger";
      });
      window.addEventListener("blur", () => {
        hasFocus = false;
      });

      function beep() {
        // ë¸Œë¼ìš°ì € ì •ì±…ìƒ ì‚¬ìš©ì ì•¡ì…˜ ì´í›„ì—ë§Œ ì•ˆì •ì ìœ¼ë¡œ ìš¸ë¦¼
        try {
          const ctx = new (window.AudioContext || window.webkitAudioContext)();
          const o = ctx.createOscillator();
          const g = ctx.createGain();
          o.type = "sine";
          o.frequency.value = 880;
          g.gain.value = 0.03;
          o.connect(g);
          g.connect(ctx.destination);
          o.start();
          setTimeout(() => { o.stop(); ctx.close(); }, 80);
        } catch {}
      }

      function notifyIncoming() {
        if (!hasFocus) {
          unread++;
          document.title = `(${unread}) WebMessenger`;
        }
        if (soundToggle.checked) beep();
      }

      // -----------------------------
      // (1) URLë¡œ ë°©ë²ˆí˜¸/ë‹‰ë„¤ì„ ìë™ ì…ì¥ (?room=1234&name=ë‹‰)
      // -----------------------------
      function getQuery() {
        const p = new URLSearchParams(location.search);
        return {
          room: (p.get("room") || "").trim(),
          name: (p.get("name") || "").trim(),
        };
      }

      function setQuery(roomId, name) {
        const p = new URLSearchParams();
        p.set("room", roomId);
        if (name) p.set("name", name);
        history.replaceState(null, "", `${location.pathname}?${p.toString()}`);
      }

      const q = getQuery();
      if (q.room) roomInput.value = q.room;
      if (q.name) nameInput.value = q.name;

      // ìƒˆ ë°© ë§Œë“¤ê¸°(ëœë¤ ë°©ë²ˆí˜¸)
      function randomRoom() {
        return String(Math.floor(1000 + Math.random() * 9000));
      }
      newRoomBtn.onclick = () => {
        roomInput.value = randomRoom();
        roomInput.focus();
      };

      // -----------------------------
      // ì…ì¥
      // -----------------------------
      function joinRoom(roomId, name) {
        socket.emit("join", { roomId, name });

        roomLabel.textContent = roomId;
        nameLabel.textContent = name;

        joinView.style.display = "none";
        chatView.style.display = "block";
        msgInput.focus();

        // ê¸°ì–µ/URL ë°˜ì˜
        localStorage.setItem("wm_name", name);
        setQuery(roomId, name);
      }

      joinBtn.onclick = () => {
        const roomId = roomInput.value.trim();
        const name = nameInput.value.trim() || "ìµëª…";

        if (!roomId) {
          alert("ë°© ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
          return;
        }
        joinRoom(roomId, name);
      };

      // Enterë¡œ ì…ì¥(í¸ì˜)
      roomInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") joinBtn.click();
      });
      nameInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") joinBtn.click();
      });

      // -----------------------------
      // (4) IRC ëª…ë ¹ì–´ ì²˜ë¦¬ (ìˆ˜ì •ëœ ë¶€ë¶„)
      // -----------------------------
      function handleCommand(text) {
        if (!text.startsWith("/")) return false;

        const [cmd, ...rest] = text.slice(1).trim().split(/\s+/);
        const arg = rest.join(" ");

        switch ((cmd || "").toLowerCase()) {
          case "help":
            appendLine("[SYSTEM] ëª…ë ¹ì–´: /help /clear /nick ìƒˆë‹‰ /me í–‰ë™");
            return true;

          case "clear":
            log.textContent = "";
            appendLine("[SYSTEM] (ë¡œê·¸ë¥¼ ë¹„ì› ìŠµë‹ˆë‹¤)");
            return true;

          case "nick": {
            const newName = arg.trim();
            if (!newName) {
              appendLine("[SYSTEM] ì‚¬ìš©ë²•: /nick ìƒˆë‹‰ë„¤ì„");
              return true;
            }

            // âœ… ì„œë²„ì—ë„ ë‹‰ ë³€ê²½ ì•Œë ¤ì„œ, ì´í›„ ì±„íŒ… nameì´ ë°”ë€Œê²Œ í•¨
            socket.emit("nick", newName);

            // í™”ë©´/ì €ì¥/URL ë°˜ì˜
            nameLabel.textContent = newName;
            localStorage.setItem("wm_name", newName);
            appendLine(`[SYSTEM] ë‹‰ë„¤ì„ ë³€ê²½: ${newName}`);
            setQuery(roomLabel.textContent, newName);

            return true;
          }

          case "me": {
            if (!arg.trim()) {
              appendLine("[SYSTEM] ì‚¬ìš©ë²•: /me í–‰ë™");
              return true;
            }
            // /meëŠ” ê·¸ëƒ¥ ë©”ì‹œì§€ë¡œ ë³´ë‚´ë˜, í‘œì‹œë§Œ ë‹¤ë¥´ê²Œ
            socket.emit("msg", `* ${nameLabel.textContent} ${arg}`);
            return true;
          }

          default:
            appendLine(`[SYSTEM] ì•Œ ìˆ˜ ì—†ëŠ” ëª…ë ¹ì–´: /${cmd} (ë„ì›€ë§: /help)`);
            return true;
        }
      }

      // -----------------------------
      // ë©”ì‹œì§€ ì „ì†¡
      // -----------------------------
      function sendMessage() {
        const text = msgInput.value.trim();
        if (!text) return;

        if (handleCommand(text)) {
          msgInput.value = "";
          msgInput.focus();
          return;
        }

        socket.emit("msg", text);
        msgInput.value = "";
        msgInput.focus();
      }

      sendBtn.onclick = sendMessage;
      msgInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") sendMessage();
      });

      // -----------------------------
      // (1) ë§í¬ ë³µì‚¬: í˜„ì¬ ë°© URLì„ í´ë¦½ë³´ë“œë¡œ
      // -----------------------------
      shareBtn.onclick = async () => {
        const url = location.href;
        try {
          await navigator.clipboard.writeText(url);
          appendLine(`[SYSTEM] ë§í¬ ë³µì‚¬ë¨: ${url}`);
        } catch {
          // fallback
          const ta = document.createElement("textarea");
          ta.value = url;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          document.body.removeChild(ta);
          appendLine("[SYSTEM] ë§í¬ ë³µì‚¬ë¨ (fallback)");
        }
      };

      // -----------------------------
      // (5) ë¡œê·¸ ë³µì‚¬
      // -----------------------------
      copyBtn.onclick = async () => {
        const text = log.textContent || "";
        if (!text.trim()) {
          appendLine("[SYSTEM] ë³µì‚¬í•  ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }
        try {
          await navigator.clipboard.writeText(text);
          appendLine("[SYSTEM] ë¡œê·¸ ë³µì‚¬ ì™„ë£Œ");
        } catch {
          appendLine("[SYSTEM] ë¡œê·¸ ë³µì‚¬ ì‹¤íŒ¨ (ë¸Œë¼ìš°ì € ê¶Œí•œ í™•ì¸)");
        }
      };

      // -----------------------------
      // ìˆ˜ì‹  ì´ë²¤íŠ¸
      // -----------------------------
      socket.on("system", (text) => {
        appendLine("[SYSTEM] " + text);
        notifyIncoming();
      });

      socket.on("msg", (payload) => {
        // IRC ìŠ¤íƒ€ì¼ ì¶œë ¥
        appendLine(`[${payload.time}] ${payload.name}: ${payload.text}`);
        notifyIncoming();
      });
    </script>

  // âœ… ì„œë²„ì—ë„ ë‹‰ ë³€ê²½ ì•Œë ¤ì„œ, ì´í›„ ì±„íŒ… nameì´ ë°”ë€Œê²Œ í•¨
  socket.emit("nick", newName);

  // í™”ë©´/ì €ì¥/URL ë°˜ì˜
  nameLabel.textContent = newName;
  localStorage.setItem("wm_name", newName);
  appendLine(`[SYSTEM] ë‹‰ë„¤ì„ ë³€ê²½: ${newName}`);
  setQuery(roomLabel.textContent, newName);

  return true;
}


  // âœ… ì„œë²„ì—ë„ ë‹‰ ë³€ê²½ ì•Œë¦¼ (ì´ê²Œ í•µì‹¬)
  socket.emit("nick", newName);

  // í™”ë©´/ì €ì¥/URL ë°˜ì˜
  nameLabel.textContent = newName;
  localStorage.setItem("wm_name", newName);
  appendLine(`[SYSTEM] ë‹‰ë„¤ì„ ë³€ê²½: ${newName}`);
  setQuery(roomLabel.textContent, newName);

  return true;
}

            // ì„œë²„ì— ì•Œë¦¬ì§„ ì•Šê³ (ê°„ë‹¨ ë²„ì „), í´ë¼ì´ì–¸íŠ¸ ë‹‰ë§Œ ë°”ê¿ˆ
            nameLabel.textContent = newName;
            localStorage.setItem("wm_name", newName);
            appendLine(`[SYSTEM] ë‹‰ë„¤ì„ ë³€ê²½: ${newName}`);
            // URLë„ ì—…ë°ì´íŠ¸
            setQuery(roomLabel.textContent, newName);

            return true;
          }

          case "me": {
            if (!arg.trim()) {
              appendLine("[SYSTEM] ì‚¬ìš©ë²•: /me í–‰ë™");
              return true;
            }
            // /meëŠ” ê·¸ëƒ¥ ë©”ì‹œì§€ë¡œ ë³´ë‚´ë˜, í‘œì‹œë§Œ ë‹¤ë¥´ê²Œ
            socket.emit("msg", `* ${nameLabel.textContent} ${arg}`);
            return true;
          }

          default:
            appendLine(`[SYSTEM] ì•Œ ìˆ˜ ì—†ëŠ” ëª…ë ¹ì–´: /${cmd} (ë„ì›€ë§: /help)`);
            return true;
        }
      }

      // -----------------------------
      // ë©”ì‹œì§€ ì „ì†¡
      // -----------------------------
      function sendMessage() {
        const text = msgInput.value.trim();
        if (!text) return;

        if (handleCommand(text)) {
          msgInput.value = "";
          msgInput.focus();
          return;
        }

        socket.emit("msg", text);
        msgInput.value = "";
        msgInput.focus();
      }

      sendBtn.onclick = sendMessage;
      msgInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") sendMessage();
      });

      // -----------------------------
      // (1) ë§í¬ ë³µì‚¬: í˜„ì¬ ë°© URLì„ í´ë¦½ë³´ë“œë¡œ
      // -----------------------------
      shareBtn.onclick = async () => {
        const url = location.href;
        try {
          await navigator.clipboard.writeText(url);
          appendLine(`[SYSTEM] ë§í¬ ë³µì‚¬ë¨: ${url}`);
        } catch {
          // fallback
          const ta = document.createElement("textarea");
          ta.value = url;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          document.body.removeChild(ta);
          appendLine("[SYSTEM] ë§í¬ ë³µì‚¬ë¨ (fallback)");
        }
      };

      // -----------------------------
      // (5) ë¡œê·¸ ë³µì‚¬
      // -----------------------------
      copyBtn.onclick = async () => {
        const text = log.textContent || "";
        if (!text.trim()) {
          appendLine("[SYSTEM] ë³µì‚¬í•  ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }
        try {
          await navigator.clipboard.writeText(text);
          appendLine("[SYSTEM] ë¡œê·¸ ë³µì‚¬ ì™„ë£Œ");
        } catch {
          appendLine("[SYSTEM] ë¡œê·¸ ë³µì‚¬ ì‹¤íŒ¨ (ë¸Œë¼ìš°ì € ê¶Œí•œ í™•ì¸)");
        }
      };

      // -----------------------------
      // ìˆ˜ì‹  ì´ë²¤íŠ¸
      // -----------------------------
      socket.on("system", (text) => {
        appendLine("[SYSTEM] " + text);
        notifyIncoming();
      });

      socket.on("msg", (payload) => {
        // IRC ìŠ¤íƒ€ì¼ ì¶œë ¥
        appendLine(`[${payload.time}] ${payload.name}: ${payload.text}`);
        notifyIncoming();
      });

      // -----------------------------
      // ì¿¼ë¦¬ì— roomì´ ìˆìœ¼ë©´ ìë™ ì…ì¥(ì²˜ìŒ ì ‘ì† í¸ì˜)
      // -----------------------------
      // ì‚¬ìš©ìê°€ ë²„íŠ¼ í´ë¦­ ì—†ì´ ë°”ë¡œ ë“¤ì–´ì˜¤ê²Œ í•˜ê³  ì‹¶ìœ¼ë©´:
      // ì•„ë˜ ì£¼ì„ í•´ì œí•˜ë©´ ë¨ (ë‹¨, ë‹‰ë„¤ì„ ì—†ìœ¼ë©´ ìµëª…ìœ¼ë¡œ ë“¤ì–´ê°)
      //
      // if (q.room) {
      //   const name = (nameInput.value.trim() || "ìµëª…");
      //   joinRoom(q.room, name);
      // }
    </script>
  </body>
</html>
